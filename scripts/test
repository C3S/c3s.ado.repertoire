#!/bin/bash
# For copyright and license terms, see COPYRIGHT.rst (top level of repository)
# Repository: https://github.com/C3S/collecting_society_docker
#
# Usage: ./test [--update]
#
# Options:
#     --update: updates the repositories (e.g. for continous integration)

echo "====================================================================="
echo "====================================================================="
echo "= this script stops, updates, builds and tests the docker setup     ="
echo "====================================================================="
echo `date +%Y-%m-%d:%H:%M:%S`

# get directories
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"
ROOT_DIR="$( dirname $SCRIPT_DIR )"
cd $ROOT_DIR

# get options
UPDATE=false
if [ $1 = "--update" ]; then UPDATE=true; fi

# stop docker containers
echo -e "\n== stop docker containers"
docker-compose stop

# update repositories
if $UPDATE; then
    echo -e "\n== update repositories"
    git pull                    # update the main repository
    $SCRIPT_DIR/update --reset  # update all other repos
fi

# build docker containers
echo -e "\n== build docker containers"
docker-compose build

# recreate test database
echo -e "\n== recreate test database"
docker-compose run --rm tryton execute create-test-db

# run tests
echo -e "\n== run tests"
docker-compose run --rm --use-aliases -e ENVIRONMENT=testing portal execute run-tests
EXITCODE=$?

# remove docker containers
echo -e "\n== remove docker containers"
docker-compose rm -fs

echo `date +%Y-%m-%d:%H:%M:%S`
echo "====================================================================="
echo "====================================================================="

cd -
exit $EXITCODE
